import { App } from "octokit";
import Encrypted from "@dtinth/encrypted";
const encrypted = Encrypted();

const githubApp = new App({
  appId: 83405,
  privateKey: encrypted`
    dGDjTHWQEXhGlZIuvL9xu6TRFL5ZuEKY.FBz4BTXj2IpdvN2lwvB8IiL8Yf+DXhXVy2q4Jag
    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
    xIvH1DMJKmmdHeO72mqZEQ9aJpFA=
  `,
});

const installationId = encrypted`EvSKGeZj/mOr8xM0onjmZwE9bKs0I5e9.YyzWnPp3VIRzlk3YGWQwLxjDSciQ7cLf`;
const dataRepo = encrypted`pNFKGNsMBYiEkKcuJmx+v6KZWC3MvGHM.C6beKnnHqZLD1huPAa2Js3H/l2rHKS1L64s0G84=`;
const notesInfrastructureApiBase = encrypted`v0qbKuAXyL7LSvYj27DpKX9d9kMzpjPQ.NWheBZmO+blpIPqhm8ArBFycarDNUHph5eRATyxkP8X5fx7hTngyiDoLS0OLV4A=`;

interface NoteFetchResult {
  preview?: {
    exp: number;
  };
  source: string;
}

async function fetchNoteFromGitHub(
  slug: string
): Promise<NoteFetchResult | undefined> {
  const octokit = await githubApp.getInstallationOctokit(installationId);
  try {
    const result = await octokit.rest.repos.getContent({
      owner: "dtinth",
      repo: dataRepo,
      path: String(slug).replace(/\W/g, "") + ".md",
    });
    if (!("content" in result.data)) {
      throw new Error("No content found");
    }
    return {
      source: Buffer.from(result.data.content, "base64").toString(),
    };
  } catch (error) {
    if ((error as any)?.response?.status === 404) {
      return undefined;
    }
    throw error;
  }
}

async function fetchNoteFromPreviewServer(
  jwt: string
): Promise<NoteFetchResult | undefined> {
  const url =
    notesInfrastructureApiBase + "/entry?jwt=" + encodeURIComponent(jwt);
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`${response.status} ${response.statusText}`);
  }
  const data = await response.json();
  return {
    source: data.data,
    preview: {
      exp: data.exp,
    },
  };
}

export function fetchNote(slug: string) {
  if (slug.startsWith("preview-")) {
    return fetchNoteFromPreviewServer(slug.substring(8));
  } else {
    return fetchNoteFromGitHub(slug);
  }
}

<!DOCTYPE html>
<html data-precompiled=true lang="en" data-dtinth="true">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tmp.spacet.me devlog part 2 | notes.dt.in.th</title><meta property="og:title" content="tmp.spacet.me devlog part 2" data-source="note">
<meta property="og:image" content="https://screenshot.source.in.th/image/_/notes/20201228T140510Z2057" data-source="note">
<meta property="og:image:width" content="1800" data-source="note">
<meta property="og:image:height" content="1680" data-source="note">
<link rel="canonical" href="https://notes.dt.in.th/20201228T140510Z2057" data-source="note"><style id="note-styles">/* layer: default */
.static[data-v-8c9498c0]{position:static;}</style>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"
      integrity="sha256-dY2Ug42wyv3rl+sLVKEg3jbPs8f+hi7tmJ836AxVDwI="
      crossorigin="anonymous"
    ></script>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/blurhash-image@1.0.1/blurhash-image.min.js"
      integrity="sha256-qrUUgTGk7xA7iVCwraHNQjwy2JryA0K4L3DL4qidagQ="
      crossorigin="anonymous"
    ></script>
    <script type="module" crossorigin src="/runtime/index.js"></script>
    <link rel="modulepreload" crossorigin href="/assets/supabase-CjkNZD6A.js">
    <link rel="stylesheet" crossorigin href="/runtime/index.css">
  </head>
  <body class="bg-#252423 text-#e9e8e7 antialiased">
    <header class="h-[58px] bg-#090807 border-b border-#454443 z-20 flex">
      <div class="flex items-center pl-[18px] flex-none">
        <a
          class="flex items-center text-#8b8685 hover:text-#ffffbb text-lg"
          href="/"
          >notes.dt.in.th</a
        >
      </div>
      <div
        class="flex-1 flex items-center text-#8b8685 [&_a:hover]:text-#ffffbb overflow-hidden"
        id="headerMiddle"
      >
        <div class="px-2 flex-none">›</div><div class="truncate"><a title="Web Platform (topic)" href="WebPlatform">Web Platform</a></div><div class="px-2 flex-none">›</div><div class="truncate"><a title="A local file storage for the web and interopearability layer for web-based apps (submission)" href="20210109T141458Z5537">A local file storage for the web and interopearability layer for web-based apps (submission)</a></div>
      </div>
      <div
        class="flex items-center px-[18px] flex-none gap-4"
        id="headerToolbar"
      ></div>
    </header>
    <div class="h-entry">
      <main class="bg-#353433" id="main">
        <div class="notes-layout-container mx-auto p-6 py-12" id="mainContents">
          <div class="prose e-content" id="noteContents"><!--[--><p data-v-8c9498c0>Now that the core is usable, I want to tackle a first use case — opening a file in an external viewer.</p><p data-v-8c9498c0>To simplify this task, for now I will use a hardcoded list of external integrations. Making this list customizable will come later.</p><p data-v-8c9498c0><strong data-v-8c9498c0>postMessage protocol:</strong> The messaging protocol I decided to use is based on <a href="https://www.jsonrpc.org/specification" data-v-8c9498c0>JSON-RPC</a> specification, following how <a href="https://microsoft.github.io/language-server-protocol/specifications/specification-current/" data-v-8c9498c0>Microsoft also uses it in its Language Server Protocol Specification</a>.</p><h2 id="results" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#results" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Results</h2><p data-v-8c9498c0>I implemented integrations for these:</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href="https://json.spacet.me" data-v-8c9498c0>json.spacet.me</a> - JSON viewer</li><li data-v-8c9498c0><a href="https://vdo.glitch.me" data-v-8c9498c0>vdo.glitch.me</a> - Video player</li></ul><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/12/28/external-viewer.png" alt="External viewer" data-v-8c9498c0></p><p data-v-8c9498c0><strong data-v-8c9498c0>How it works:</strong> When opening a file with an external viewer, tmp.spacet.me opens up a new window, passing along a session ID. Once the viewer loads and detects the session ID, it makes a JSON-RPC call to the opener to obtain the file contents.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/12/28/tmp-communication.png" alt="Communication" data-v-8c9498c0></p><h2 id="implementation-and-refactoring" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#implementation-and-refactoring" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Implementation and refactoring</h2><p data-v-8c9498c0>I started by <a href="http://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork" data-v-8c9498c0>doing the simplest thing that could possibly work</a> and hardcoded the <code data-v-8c9498c0>postMessage</code> handling code. Here the code is infested with type assertions just to make TypeScript compiler happy. When experimenting, I think this is a good thing to do, just don&#39;t forget to clean it up later, which is coming up right next.</p><p data-v-8c9498c0>You don&#39;t need to understand the whole code here, just look at the code around the comments:</p><pre class="shiki github-dark" style="background-color:#252423;color:#e1e4e8;" tabindex="0" data-v-8c9498c0><code data-v-8c9498c0><span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>window.</span><span style="color:#B392F0;" data-v-8c9498c0>addEventListener</span><span style="color:#E1E4E8;" data-v-8c9498c0>(</span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;message&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>, </span><span style="color:#F97583;" data-v-8c9498c0>async</span><span style="color:#E1E4E8;" data-v-8c9498c0> (</span><span style="color:#FFAB70;" data-v-8c9498c0>e</span><span style="color:#E1E4E8;" data-v-8c9498c0>) </span><span style="color:#F97583;" data-v-8c9498c0>=&gt;</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>  const</span><span style="color:#79B8FF;" data-v-8c9498c0> fromWindow</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> (e.source </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#79B8FF;" data-v-8c9498c0> unknown</span><span style="color:#E1E4E8;" data-v-8c9498c0>) </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#B392F0;" data-v-8c9498c0> Window</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>  // Check for a method call.</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>  if</span><span style="color:#E1E4E8;" data-v-8c9498c0> (e.data.method </span><span style="color:#F97583;" data-v-8c9498c0>===</span><span style="color:#9ECBFF;" data-v-8c9498c0> &#39;tmp/getOpenedFile&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>) {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>    // In this block, `e.data` is `any`, so no IntelliSense.</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>    // (hovertip) const sessionId: any</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> sessionId</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> e.data.params.sessionId</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> session</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> sessionStorage[</span><span style="color:#9ECBFF;" data-v-8c9498c0>`session:${</span><span style="color:#E1E4E8;" data-v-8c9498c0>sessionId</span><span style="color:#9ECBFF;" data-v-8c9498c0>}`</span><span style="color:#E1E4E8;" data-v-8c9498c0>]</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    if</span><span style="color:#E1E4E8;" data-v-8c9498c0> (</span><span style="color:#F97583;" data-v-8c9498c0>!</span><span style="color:#E1E4E8;" data-v-8c9498c0>session) </span><span style="color:#F97583;" data-v-8c9498c0>return</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> sessionState</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#79B8FF;" data-v-8c9498c0> JSON</span><span style="color:#E1E4E8;" data-v-8c9498c0>.</span><span style="color:#B392F0;" data-v-8c9498c0>parse</span><span style="color:#E1E4E8;" data-v-8c9498c0>(session)</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> db</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#B392F0;" data-v-8c9498c0> getFilesDatabase</span><span style="color:#E1E4E8;" data-v-8c9498c0>()</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> doc</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#F97583;" data-v-8c9498c0> await</span><span style="color:#E1E4E8;" data-v-8c9498c0> db.</span><span style="color:#B392F0;" data-v-8c9498c0>get</span><span style="color:#E1E4E8;" data-v-8c9498c0>(sessionState.openedFile, {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      binary: </span><span style="color:#79B8FF;" data-v-8c9498c0>true</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      attachments: </span><span style="color:#79B8FF;" data-v-8c9498c0>true</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    })</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    fromWindow.</span><span style="color:#B392F0;" data-v-8c9498c0>postMessage</span><span style="color:#E1E4E8;" data-v-8c9498c0>(</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>      // Send a reply.</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // Right now this object can be arbitrary payload;</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // there&#39;s currently no type-checking here.</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // So I might introduce a bug at some point...</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        jsonrpc: </span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;2.0&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        id: e.data.id,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        result: {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          blob: (doc._attachments.blob </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#79B8FF;" data-v-8c9498c0> any</span><span style="color:#E1E4E8;" data-v-8c9498c0>).data,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          file: {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>            _rev: doc._rev,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>            _id: doc._id,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>            name: doc.name,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>            type: doc.type,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          },</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        },</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      },</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      e.origin</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    )</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>})</span></span></code></pre><p data-v-8c9498c0>Now while this works, I can see that this way of writing code can cause trouble soon. Right now to answer these questions you would need to read how the code is implemented, because it has never been explicitly stated, nor documented, in the code base:</p><ul data-v-8c9498c0><li data-v-8c9498c0>Which methods are available?</li><li data-v-8c9498c0>What kind of parameters do these methods take?</li><li data-v-8c9498c0>What do the results look like for each method?</li></ul><p data-v-8c9498c0>This makes the interface prone to break, and I don&#39;t want that. I think in this case static typing could help here. So I went ahead and created a TypeScript interface as a way to document the RPC interface. <a href="http://me.dt.in.th/page/ImplementLater" data-v-8c9498c0>I wrote it in a way that I want to read it in the future.</a></p><pre class="shiki github-dark" style="background-color:#252423;color:#e1e4e8;" tabindex="0" data-v-8c9498c0><code data-v-8c9498c0><span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>interface</span><span style="color:#B392F0;" data-v-8c9498c0> RpcInterface</span><span style="color:#F97583;" data-v-8c9498c0> extends</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcDefinition</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#9ECBFF;" data-v-8c9498c0>  &#39;tmp/getOpenedFile&#39;</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    params</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>      sessionId</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    result</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>      blob</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> Blob</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>      file</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>        _rev</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>        _id</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>        name</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>        type</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>}</span></span></code></pre><p data-v-8c9498c0>Now, the message handler looks like this:</p><pre class="shiki github-dark" style="background-color:#252423;color:#e1e4e8;" tabindex="0" data-v-8c9498c0><code data-v-8c9498c0><span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>const</span><span style="color:#79B8FF;" data-v-8c9498c0> rpc</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#F97583;" data-v-8c9498c0> new</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcPayloadChecker</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>RpcInterface</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt;()</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>window.</span><span style="color:#B392F0;" data-v-8c9498c0>addEventListener</span><span style="color:#E1E4E8;" data-v-8c9498c0>(</span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;message&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>, </span><span style="color:#F97583;" data-v-8c9498c0>async</span><span style="color:#E1E4E8;" data-v-8c9498c0> (</span><span style="color:#FFAB70;" data-v-8c9498c0>e</span><span style="color:#E1E4E8;" data-v-8c9498c0>) </span><span style="color:#F97583;" data-v-8c9498c0>=&gt;</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>  const</span><span style="color:#79B8FF;" data-v-8c9498c0> fromWindow</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> (e.source </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#79B8FF;" data-v-8c9498c0> unknown</span><span style="color:#E1E4E8;" data-v-8c9498c0>) </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#B392F0;" data-v-8c9498c0> Window</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>  // Changed</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>  if</span><span style="color:#E1E4E8;" data-v-8c9498c0> (rpc.</span><span style="color:#B392F0;" data-v-8c9498c0>isMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>(e.data, </span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;tmp/getOpenedFile&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>)) {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>    // In this block, `e.data.params` shall have type</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>    // `RpcInterface[&#39;tmp/getOpenedFile&#39;]` which is `{ sessionId: string }`</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>    // (hovertip) const sessionId: string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> sessionId</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> e.data.params.sessionId</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> session</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#E1E4E8;" data-v-8c9498c0> sessionStorage[</span><span style="color:#9ECBFF;" data-v-8c9498c0>`session:${</span><span style="color:#E1E4E8;" data-v-8c9498c0>sessionId</span><span style="color:#9ECBFF;" data-v-8c9498c0>}`</span><span style="color:#E1E4E8;" data-v-8c9498c0>]</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    if</span><span style="color:#E1E4E8;" data-v-8c9498c0> (</span><span style="color:#F97583;" data-v-8c9498c0>!</span><span style="color:#E1E4E8;" data-v-8c9498c0>session) </span><span style="color:#F97583;" data-v-8c9498c0>return</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> sessionState</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#79B8FF;" data-v-8c9498c0> JSON</span><span style="color:#E1E4E8;" data-v-8c9498c0>.</span><span style="color:#B392F0;" data-v-8c9498c0>parse</span><span style="color:#E1E4E8;" data-v-8c9498c0>(session)</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> db</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#B392F0;" data-v-8c9498c0> getFilesDatabase</span><span style="color:#E1E4E8;" data-v-8c9498c0>()</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    const</span><span style="color:#79B8FF;" data-v-8c9498c0> doc</span><span style="color:#F97583;" data-v-8c9498c0> =</span><span style="color:#F97583;" data-v-8c9498c0> await</span><span style="color:#E1E4E8;" data-v-8c9498c0> db.</span><span style="color:#B392F0;" data-v-8c9498c0>get</span><span style="color:#E1E4E8;" data-v-8c9498c0>(sessionState.openedFile, {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      binary: </span><span style="color:#79B8FF;" data-v-8c9498c0>true</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      attachments: </span><span style="color:#79B8FF;" data-v-8c9498c0>true</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    })</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    fromWindow.</span><span style="color:#B392F0;" data-v-8c9498c0>postMessage</span><span style="color:#E1E4E8;" data-v-8c9498c0>(</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>      // Changed</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      rpc.</span><span style="color:#B392F0;" data-v-8c9498c0>replyResult</span><span style="color:#E1E4E8;" data-v-8c9498c0>(e.data, {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // In here, the type should flow to this object.</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // So any deviations from the declared interface</span></span>
<span class="line" data-v-8c9498c0><span style="color:#6A737D;" data-v-8c9498c0>        // would cause a type-checking error.</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        blob: (doc._attachments.blob </span><span style="color:#F97583;" data-v-8c9498c0>as</span><span style="color:#79B8FF;" data-v-8c9498c0> any</span><span style="color:#E1E4E8;" data-v-8c9498c0>).data,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        file: {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          _rev: doc._rev,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          _id: doc._id,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          name: doc.name,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>          type: doc.type,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>        },</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      }),</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      e.origin</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    )</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>})</span></span></code></pre><p data-v-8c9498c0>To make the type flow, here is the rest of that code. This is, IMO, one of the very few places where I would write advanced types. IMO advanced types hurt the readability of code, so it is best used in an isolated place, where it will make types flow better to the code that uses it. TypeScript tax is a thing, but let&#39;s manage it instead of avoiding it.</p><p data-v-8c9498c0>A litmus test I use for when to use advanced types is this: Does it reduce the amount of type annotations in other files? Don&#39;t let advanced types infect the rest of your codebase!</p><pre class="shiki github-dark" style="background-color:#252423;color:#e1e4e8;" tabindex="0" data-v-8c9498c0><code data-v-8c9498c0><span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>export</span><span style="color:#F97583;" data-v-8c9498c0> class</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcPayloadChecker</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>T</span><span style="color:#F97583;" data-v-8c9498c0> extends</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcDefinition</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt; {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#B392F0;" data-v-8c9498c0>  isMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#F97583;" data-v-8c9498c0> extends</span><span style="color:#F97583;" data-v-8c9498c0> keyof</span><span style="color:#B392F0;" data-v-8c9498c0> T</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt;(</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    message</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> unknown</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    method</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> K</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  )</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#FFAB70;" data-v-8c9498c0> message</span><span style="color:#F97583;" data-v-8c9498c0> is</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#E1E4E8;" data-v-8c9498c0>, </span><span style="color:#B392F0;" data-v-8c9498c0>T</span><span style="color:#E1E4E8;" data-v-8c9498c0>[</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#E1E4E8;" data-v-8c9498c0>][</span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;params&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>]&gt; {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    return</span><span style="color:#B392F0;" data-v-8c9498c0> isJsonRpcMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>(message) </span><span style="color:#F97583;" data-v-8c9498c0>&amp;&amp;</span><span style="color:#E1E4E8;" data-v-8c9498c0> message.method </span><span style="color:#F97583;" data-v-8c9498c0>===</span><span style="color:#E1E4E8;" data-v-8c9498c0> method</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#B392F0;" data-v-8c9498c0>  replyResult</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#F97583;" data-v-8c9498c0> extends</span><span style="color:#F97583;" data-v-8c9498c0> keyof</span><span style="color:#B392F0;" data-v-8c9498c0> T</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt;(</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    message</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#E1E4E8;" data-v-8c9498c0>, </span><span style="color:#79B8FF;" data-v-8c9498c0>any</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt;,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    result</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> T</span><span style="color:#E1E4E8;" data-v-8c9498c0>[</span><span style="color:#B392F0;" data-v-8c9498c0>K</span><span style="color:#E1E4E8;" data-v-8c9498c0>][</span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;result&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>]</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  ) {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>    return</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      jsonrpc: </span><span style="color:#9ECBFF;" data-v-8c9498c0>&#39;2.0&#39;</span><span style="color:#E1E4E8;" data-v-8c9498c0>,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      id: message.id,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>      result: result,</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>    }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>}</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>export</span><span style="color:#F97583;" data-v-8c9498c0> interface</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcDefinition</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  [</span><span style="color:#FFAB70;" data-v-8c9498c0>methodName</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span><span style="color:#E1E4E8;" data-v-8c9498c0>]</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#E1E4E8;" data-v-8c9498c0> {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    params</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> any</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>    result</span><span style="color:#F97583;" data-v-8c9498c0>?:</span><span style="color:#79B8FF;" data-v-8c9498c0> any</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>  }</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>}</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>export</span><span style="color:#F97583;" data-v-8c9498c0> interface</span><span style="color:#B392F0;" data-v-8c9498c0> JsonRpcMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>&lt;</span><span style="color:#B392F0;" data-v-8c9498c0>MethodName</span><span style="color:#E1E4E8;" data-v-8c9498c0>, </span><span style="color:#B392F0;" data-v-8c9498c0>MethodParams</span><span style="color:#E1E4E8;" data-v-8c9498c0>&gt; {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>  id</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> string</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>  method</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> MethodName</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>  params</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#B392F0;" data-v-8c9498c0> MethodParams</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>}</span></span>
<span class="line" data-v-8c9498c0></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>function</span><span style="color:#B392F0;" data-v-8c9498c0> isJsonRpcMethodCall</span><span style="color:#E1E4E8;" data-v-8c9498c0>(</span></span>
<span class="line" data-v-8c9498c0><span style="color:#FFAB70;" data-v-8c9498c0>  message</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#79B8FF;" data-v-8c9498c0> any</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>)</span><span style="color:#F97583;" data-v-8c9498c0>:</span><span style="color:#FFAB70;" data-v-8c9498c0> message</span><span style="color:#F97583;" data-v-8c9498c0> is</span><span style="color:#E1E4E8;" data-v-8c9498c0> { </span><span style="color:#B392F0;" data-v-8c9498c0>method</span><span style="color:#E1E4E8;" data-v-8c9498c0>: string; </span><span style="color:#B392F0;" data-v-8c9498c0>params</span><span style="color:#E1E4E8;" data-v-8c9498c0>: any } {</span></span>
<span class="line" data-v-8c9498c0><span style="color:#F97583;" data-v-8c9498c0>  return</span><span style="color:#E1E4E8;" data-v-8c9498c0> message </span><span style="color:#F97583;" data-v-8c9498c0>&amp;&amp;</span><span style="color:#E1E4E8;" data-v-8c9498c0> message.method</span></span>
<span class="line" data-v-8c9498c0><span style="color:#E1E4E8;" data-v-8c9498c0>}</span></span></code></pre><!--]--></div>
        </div>
      </main>
      <footer>
        <div
          class="notes-layout-container mx-auto py-4 px-6 text-#8b8685 text-right text-sm"
          id="footerContents"
        >
          <notes-page-footer></notes-page-footer>
        </div>
      </footer>
    </div>
    <script>
window.precompiledNoteBehavior = function(require, exports, module, Vue) {"use strict";Object.defineProperty(exports, "__esModule", {value: true});const __sfc__ = {};
var _vue = require('vue');

const _withScopeId = n => (_vue.pushScopeId.call(void 0, "data-v-8c9498c0"),n=n(),_vue.popScopeId.call(void 0, ),n)
const _hoisted_1 = /*#__PURE__*/_vue.createStaticVNode.call(void 0, "<p data-v-8c9498c0>Now that the core is usable, I want to tackle a first use case — opening a file in an external viewer.</p><p data-v-8c9498c0>To simplify this task, for now I will use a hardcoded list of external integrations. Making this list customizable will come later.</p><p data-v-8c9498c0><strong data-v-8c9498c0>postMessage protocol:</strong> The messaging protocol I decided to use is based on <a href=\"https://www.jsonrpc.org/specification\" data-v-8c9498c0>JSON-RPC</a> specification, following how <a href=\"https://microsoft.github.io/language-server-protocol/specifications/specification-current/\" data-v-8c9498c0>Microsoft also uses it in its Language Server Protocol Specification</a>.</p><h2 id=\"results\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#results\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Results</h2><p data-v-8c9498c0>I implemented integrations for these:</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href=\"https://json.spacet.me\" data-v-8c9498c0>json.spacet.me</a> - JSON viewer</li><li data-v-8c9498c0><a href=\"https://vdo.glitch.me\" data-v-8c9498c0>vdo.glitch.me</a> - Video player</li></ul><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/12/28/external-viewer.png\" alt=\"External viewer\" data-v-8c9498c0></p><p data-v-8c9498c0><strong data-v-8c9498c0>How it works:</strong> When opening a file with an external viewer, tmp.spacet.me opens up a new window, passing along a session ID. Once the viewer loads and detects the session ID, it makes a JSON-RPC call to the opener to obtain the file contents.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/12/28/tmp-communication.png\" alt=\"Communication\" data-v-8c9498c0></p><h2 id=\"implementation-and-refactoring\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#implementation-and-refactoring\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Implementation and refactoring</h2><p data-v-8c9498c0>I started by <a href=\"http://wiki.c2.com/?DoTheSimplestThingThatCouldPossiblyWork\" data-v-8c9498c0>doing the simplest thing that could possibly work</a> and hardcoded the <code data-v-8c9498c0>postMessage</code> handling code. Here the code is infested with type assertions just to make TypeScript compiler happy. When experimenting, I think this is a good thing to do, just don&#39;t forget to clean it up later, which is coming up right next.</p><p data-v-8c9498c0>You don&#39;t need to understand the whole code here, just look at the code around the comments:</p><pre class=\"shiki github-dark\" style=\"background-color:#252423;color:#e1e4e8;\" tabindex=\"0\" data-v-8c9498c0><code data-v-8c9498c0><span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>window.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>addEventListener</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;message&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>, </span><span style=\"color:#F97583;\" data-v-8c9498c0>async</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (</span><span style=\"color:#FFAB70;\" data-v-8c9498c0>e</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>) </span><span style=\"color:#F97583;\" data-v-8c9498c0>=&gt;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>  const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> fromWindow</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (e.source </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> unknown</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>) </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#B392F0;\" data-v-8c9498c0> Window</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>  // Check for a method call.</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>  if</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (e.data.method </span><span style=\"color:#F97583;\" data-v-8c9498c0>===</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0> &#39;tmp/getOpenedFile&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>) {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>    // In this block, `e.data` is `any`, so no IntelliSense.</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>    // (hovertip) const sessionId: any</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> sessionId</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> e.data.params.sessionId</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> session</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> sessionStorage[</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>`session:${</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>sessionId</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>}`</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>]</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    if</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (</span><span style=\"color:#F97583;\" data-v-8c9498c0>!</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>session) </span><span style=\"color:#F97583;\" data-v-8c9498c0>return</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> sessionState</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> JSON</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>parse</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(session)</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> db</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#B392F0;\" data-v-8c9498c0> getFilesDatabase</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>()</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> doc</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#F97583;\" data-v-8c9498c0> await</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> db.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>get</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(sessionState.openedFile, {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      binary: </span><span style=\"color:#79B8FF;\" data-v-8c9498c0>true</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      attachments: </span><span style=\"color:#79B8FF;\" data-v-8c9498c0>true</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    })</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    fromWindow.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>postMessage</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>      // Send a reply.</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // Right now this object can be arbitrary payload;</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // there&#39;s currently no type-checking here.</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // So I might introduce a bug at some point...</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        jsonrpc: </span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;2.0&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        id: e.data.id,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        result: {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          blob: (doc._attachments.blob </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> any</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>).data,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          file: {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>            _rev: doc._rev,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>            _id: doc._id,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>            name: doc.name,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>            type: doc.type,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          },</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        },</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      },</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      e.origin</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    )</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>})</span></span></code></pre><p data-v-8c9498c0>Now while this works, I can see that this way of writing code can cause trouble soon. Right now to answer these questions you would need to read how the code is implemented, because it has never been explicitly stated, nor documented, in the code base:</p><ul data-v-8c9498c0><li data-v-8c9498c0>Which methods are available?</li><li data-v-8c9498c0>What kind of parameters do these methods take?</li><li data-v-8c9498c0>What do the results look like for each method?</li></ul><p data-v-8c9498c0>This makes the interface prone to break, and I don&#39;t want that. I think in this case static typing could help here. So I went ahead and created a TypeScript interface as a way to document the RPC interface. <a href=\"http://me.dt.in.th/page/ImplementLater\" data-v-8c9498c0>I wrote it in a way that I want to read it in the future.</a></p><pre class=\"shiki github-dark\" style=\"background-color:#252423;color:#e1e4e8;\" tabindex=\"0\" data-v-8c9498c0><code data-v-8c9498c0><span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>interface</span><span style=\"color:#B392F0;\" data-v-8c9498c0> RpcInterface</span><span style=\"color:#F97583;\" data-v-8c9498c0> extends</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcDefinition</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#9ECBFF;\" data-v-8c9498c0>  &#39;tmp/getOpenedFile&#39;</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    params</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>      sessionId</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    result</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>      blob</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> Blob</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>      file</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>        _rev</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>        _id</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>        name</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>        type</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>}</span></span></code></pre><p data-v-8c9498c0>Now, the message handler looks like this:</p><pre class=\"shiki github-dark\" style=\"background-color:#252423;color:#e1e4e8;\" tabindex=\"0\" data-v-8c9498c0><code data-v-8c9498c0><span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> rpc</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#F97583;\" data-v-8c9498c0> new</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcPayloadChecker</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>RpcInterface</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt;()</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>window.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>addEventListener</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;message&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>, </span><span style=\"color:#F97583;\" data-v-8c9498c0>async</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (</span><span style=\"color:#FFAB70;\" data-v-8c9498c0>e</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>) </span><span style=\"color:#F97583;\" data-v-8c9498c0>=&gt;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>  const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> fromWindow</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (e.source </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> unknown</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>) </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#B392F0;\" data-v-8c9498c0> Window</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>  // Changed</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>  if</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (rpc.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>isMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(e.data, </span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;tmp/getOpenedFile&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>)) {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>    // In this block, `e.data.params` shall have type</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>    // `RpcInterface[&#39;tmp/getOpenedFile&#39;]` which is `{ sessionId: string }`</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>    // (hovertip) const sessionId: string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> sessionId</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> e.data.params.sessionId</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> session</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> sessionStorage[</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>`session:${</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>sessionId</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>}`</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>]</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    if</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> (</span><span style=\"color:#F97583;\" data-v-8c9498c0>!</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>session) </span><span style=\"color:#F97583;\" data-v-8c9498c0>return</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> sessionState</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> JSON</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>parse</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(session)</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> db</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#B392F0;\" data-v-8c9498c0> getFilesDatabase</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>()</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    const</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> doc</span><span style=\"color:#F97583;\" data-v-8c9498c0> =</span><span style=\"color:#F97583;\" data-v-8c9498c0> await</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> db.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>get</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(sessionState.openedFile, {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      binary: </span><span style=\"color:#79B8FF;\" data-v-8c9498c0>true</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      attachments: </span><span style=\"color:#79B8FF;\" data-v-8c9498c0>true</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    })</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    fromWindow.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>postMessage</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>      // Changed</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      rpc.</span><span style=\"color:#B392F0;\" data-v-8c9498c0>replyResult</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(e.data, {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // In here, the type should flow to this object.</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // So any deviations from the declared interface</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#6A737D;\" data-v-8c9498c0>        // would cause a type-checking error.</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        blob: (doc._attachments.blob </span><span style=\"color:#F97583;\" data-v-8c9498c0>as</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> any</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>).data,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        file: {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          _rev: doc._rev,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          _id: doc._id,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          name: doc.name,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>          type: doc.type,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>        },</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      }),</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      e.origin</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    )</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>})</span></span></code></pre><p data-v-8c9498c0>To make the type flow, here is the rest of that code. This is, IMO, one of the very few places where I would write advanced types. IMO advanced types hurt the readability of code, so it is best used in an isolated place, where it will make types flow better to the code that uses it. TypeScript tax is a thing, but let&#39;s manage it instead of avoiding it.</p><p data-v-8c9498c0>A litmus test I use for when to use advanced types is this: Does it reduce the amount of type annotations in other files? Don&#39;t let advanced types infect the rest of your codebase!</p><pre class=\"shiki github-dark\" style=\"background-color:#252423;color:#e1e4e8;\" tabindex=\"0\" data-v-8c9498c0><code data-v-8c9498c0><span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>export</span><span style=\"color:#F97583;\" data-v-8c9498c0> class</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcPayloadChecker</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>T</span><span style=\"color:#F97583;\" data-v-8c9498c0> extends</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcDefinition</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt; {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#B392F0;\" data-v-8c9498c0>  isMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#F97583;\" data-v-8c9498c0> extends</span><span style=\"color:#F97583;\" data-v-8c9498c0> keyof</span><span style=\"color:#B392F0;\" data-v-8c9498c0> T</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt;(</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    message</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> unknown</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    method</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> K</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  )</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#FFAB70;\" data-v-8c9498c0> message</span><span style=\"color:#F97583;\" data-v-8c9498c0> is</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>, </span><span style=\"color:#B392F0;\" data-v-8c9498c0>T</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>[</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>][</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;params&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>]&gt; {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    return</span><span style=\"color:#B392F0;\" data-v-8c9498c0> isJsonRpcMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(message) </span><span style=\"color:#F97583;\" data-v-8c9498c0>&amp;&amp;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> message.method </span><span style=\"color:#F97583;\" data-v-8c9498c0>===</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> method</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#B392F0;\" data-v-8c9498c0>  replyResult</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#F97583;\" data-v-8c9498c0> extends</span><span style=\"color:#F97583;\" data-v-8c9498c0> keyof</span><span style=\"color:#B392F0;\" data-v-8c9498c0> T</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt;(</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    message</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>, </span><span style=\"color:#79B8FF;\" data-v-8c9498c0>any</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt;,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    result</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> T</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>[</span><span style=\"color:#B392F0;\" data-v-8c9498c0>K</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>][</span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;result&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>]</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  ) {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>    return</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      jsonrpc: </span><span style=\"color:#9ECBFF;\" data-v-8c9498c0>&#39;2.0&#39;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      id: message.id,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>      result: result,</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>    }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>}</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>export</span><span style=\"color:#F97583;\" data-v-8c9498c0> interface</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcDefinition</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  [</span><span style=\"color:#FFAB70;\" data-v-8c9498c0>methodName</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>]</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    params</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> any</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>    result</span><span style=\"color:#F97583;\" data-v-8c9498c0>?:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> any</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>  }</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>}</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>export</span><span style=\"color:#F97583;\" data-v-8c9498c0> interface</span><span style=\"color:#B392F0;\" data-v-8c9498c0> JsonRpcMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&lt;</span><span style=\"color:#B392F0;\" data-v-8c9498c0>MethodName</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>, </span><span style=\"color:#B392F0;\" data-v-8c9498c0>MethodParams</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>&gt; {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>  id</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> string</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>  method</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> MethodName</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>  params</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#B392F0;\" data-v-8c9498c0> MethodParams</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>}</span></span>\n<span class=\"line\" data-v-8c9498c0></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>function</span><span style=\"color:#B392F0;\" data-v-8c9498c0> isJsonRpcMethodCall</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>(</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#FFAB70;\" data-v-8c9498c0>  message</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#79B8FF;\" data-v-8c9498c0> any</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>)</span><span style=\"color:#F97583;\" data-v-8c9498c0>:</span><span style=\"color:#FFAB70;\" data-v-8c9498c0> message</span><span style=\"color:#F97583;\" data-v-8c9498c0> is</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> { </span><span style=\"color:#B392F0;\" data-v-8c9498c0>method</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>: string; </span><span style=\"color:#B392F0;\" data-v-8c9498c0>params</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0>: any } {</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#F97583;\" data-v-8c9498c0>  return</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> message </span><span style=\"color:#F97583;\" data-v-8c9498c0>&amp;&amp;</span><span style=\"color:#E1E4E8;\" data-v-8c9498c0> message.method</span></span>\n<span class=\"line\" data-v-8c9498c0><span style=\"color:#E1E4E8;\" data-v-8c9498c0>}</span></span></code></pre>", 22)
function render(_ctx, _cache) {
  return _hoisted_1
}
__sfc__.render = render
__sfc__.__scopeId = "data-v-8c9498c0"
__sfc__.__file = "Note.vue"
exports. default = __sfc__};
window.precompiledFrontMatter = {"title":"tmp.spacet.me devlog part 2","tags":"dohackathon","series":"tmp.spacet.me devlog","public":true,"devto":"https://dev.to/dtinth/tmp-spacet-me-devlog-part-2-34hi"};
</script>
  </body>
</html>

<!DOCTYPE html>
<html data-precompiled=true lang="en" data-dtinth="true">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Building a personal but multi-tenant web page screenshotting service with Puppeteer and Vercel | notes.dt.in.th</title><meta property="og:title" content="Building a personal but multi-tenant web page screenshotting service with Puppeteer and Vercel" data-source="note">
<meta property="og:image" content="https://screenshot.source.in.th/image/_/notes/PersonalPuppeteer" data-source="note">
<meta property="og:image:width" content="1800" data-source="note">
<meta property="og:image:height" content="1680" data-source="note">
<link rel="canonical" href="https://notes.dt.in.th/PersonalPuppeteer" data-source="note"><style id="note-styles">/* layer: default */
.my[data-v-8c9498c0]{margin-top:1rem;margin-bottom:1rem;}</style>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"
      integrity="sha256-dY2Ug42wyv3rl+sLVKEg3jbPs8f+hi7tmJ836AxVDwI="
      crossorigin="anonymous"
    ></script>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/blurhash-image@1.0.1/blurhash-image.min.js"
      integrity="sha256-qrUUgTGk7xA7iVCwraHNQjwy2JryA0K4L3DL4qidagQ="
      crossorigin="anonymous"
    ></script>
    <script type="module" crossorigin src="/runtime/index.js"></script>
    <link rel="modulepreload" crossorigin href="/assets/supabase-CjkNZD6A.js">
    <link rel="stylesheet" crossorigin href="/runtime/index.css">
  </head>
  <body class="bg-#252423 text-#e9e8e7 antialiased">
    <header class="h-[58px] bg-#090807 border-b border-#454443 z-20 flex">
      <div class="flex items-center pl-[18px] flex-none">
        <a
          class="flex items-center text-#8b8685 hover:text-#ffffbb text-lg"
          href="/"
          >notes.dt.in.th</a
        >
      </div>
      <div
        class="flex-1 flex items-center text-#8b8685 [&_a:hover]:text-#ffffbb overflow-hidden"
        id="headerMiddle"
      >
        <div class="px-2 flex-none">›</div><div class="truncate"><a title="Cloud Platform (topic)" href="CloudPlatform">Cloud Platform</a></div><div class="px-2 flex-none">›</div><div class="truncate"><a title="Vercel (topic)" href="Vercel">Vercel</a></div>
      </div>
      <div
        class="flex items-center px-[18px] flex-none gap-4"
        id="headerToolbar"
      ></div>
    </header>
    <div class="h-entry">
      <main class="bg-#353433" id="main">
        <div class="notes-layout-container mx-auto p-6 py-12" id="mainContents">
          <div class="prose e-content" id="noteContents"><!--[--><div class="notes-callout" data-type="Caution" data-v-8c9498c0><p class="notes-callout__label" data-v-8c9498c0><!---->Outdated</p><p data-v-8c9498c0>I no longer use this solution, and no longer maintain this project, as the solution to run Chrome in Vercel (<a href="https://www.npmjs.com/package/chrome-aws-lambda" data-v-8c9498c0>chrome-aws-lambda</a>) hasn’t been updated in 3 years, causing websites to be rendered incorrectly. As of 2023, I run a private instance of <a href="https://github.com/dtinth/pptraas" data-v-8c9498c0>pptraas</a> on Google Cloud Run and built a little gateway service on top of it. The source code for that part is not published, but basically, it invokes pptraas, saves the generated image in Linode Object Storage, and uses PostgreSQL to keep track of when the image was last generated. The list of allowed URLs and its corresponding configuration is stored in Google Sheets so it’s easy to manage.</p></div><p data-v-8c9498c0>In the past 2 years I found myself having to install and configure <a href="https://github.com/puppeteer/puppeteer" data-v-8c9498c0>Puppeteer</a> to capture webpage screenshots on so many occasions.</p><p data-v-8c9498c0>So I thought it would be great to have a generic API that captures webpage screenshots that I can reuse across multiple projects. The existence of serverless platforms like <a href="Vercel" data-v-8c9498c0>Vercel</a> made it all the more easier to do this, even for personal projects.</p><h2 id="the-need-for-screenshotting-web-pages" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#the-need-for-screenshotting-web-pages" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>The need for screenshotting web pages</h2><p data-v-8c9498c0>I regularly find need to programmatically take screenshots of web pages.</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href="https://github.com/dtinth/timelapse" data-v-8c9498c0>To capture a timelapse of my personal projects</a></li><li data-v-8c9498c0><a href="https://github.com/dtinth/html5-animation-video-renderer" data-v-8c9498c0>To render web-based animations into a video file</a></li><li data-v-8c9498c0><a href="https://github.com/dtinth/applitools-hackathon#canvas-chart-test" data-v-8c9498c0>To perform visual regression testing</a></li><li data-v-8c9498c0><a href="https://github.com/reactbkk/3.0.0-posters-nametags/blob/master/src/take-screenshot.js" data-v-8c9498c0>To procedurally generate image assets in batch</a></li></ul><p data-v-8c9498c0>In each of these use cases I installed <a href="https://github.com/puppeteer/puppeteer" data-v-8c9498c0>Puppeteer</a> and wrote similar code: Go to the web page, take a screenshot, output the image. But Puppeteer is quite a heavy dependency, weighting over 100 MB in <code data-v-8c9498c0>node_modules</code>.</p><p data-v-8c9498c0>In cases where the code is used in dynamic sites, I would had to set up <a href="https://rominirani.com/using-puppeteer-in-google-cloud-functions-809a14856e14" data-v-8c9498c0>a Google Cloud function</a> or <a href="https://github.com/alixaxel/chrome-aws-lambda" data-v-8c9498c0>an AWS Lambda function</a> for that use cases.</p><p data-v-8c9498c0>Wouldn’t it be great if, instead of setting up Puppeteer every time, there is an API that I can immediately use? Well, there is a <a href="https://phantomjscloud.com/" data-v-8c9498c0>plenty</a> <a href="https://www.browserless.io/" data-v-8c9498c0>of</a> <a href="https://puppet-master.sh/" data-v-8c9498c0><del data-v-8c9498c0>existing</del></a> <a href="https://urlbox.io/" data-v-8c9498c0>offerings</a>, but most of them are paid and <a href="https://github.com/GoogleChromeLabs/pptraas.com/issues/48" data-v-8c9498c0>the free ones went down</a>. Even some of the paid ones went down (the links that are struck out are now dead).</p><p data-v-8c9498c0>Since I wanted to re-use it across multiple projects, spanning multiple years to come, I want some degree of control. The service should:</p><ul data-v-8c9498c0><li data-v-8c9498c0><strong data-v-8c9498c0>Run on my own domain name.</strong> I don&#39;t want to have to go through all my projects and migrate to a new service, just because the old service is sunsetted.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Be affordable or free.</strong> It’s for personal use and is non-commercial. I don’t want to spend too much money on it.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Personal yet multi-tenant.</strong> I may use it on a project that is shared with others. In a rare case that I need to revoke an access to one project, it should not disrupt other projects. Therefore, it should support multiple keys.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Secure.</strong> Others should not be able to use the service to screenshot arbitrary web pages without my permission.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Single-shot API.</strong> Service consumers should be able to construct the image URL without having to make any extra API requests.</li></ul><h2 id="introducing-personal-puppeteer" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#introducing-personal-puppeteer" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Introducing personal-puppeteer</h2><p data-v-8c9498c0>So this is what I created. Here’s how it works:</p><p data-v-8c9498c0>First, let’s say I want to generate a <strong data-v-8c9498c0>social card image</strong> for the URL at <code data-v-8c9498c0>https://capture.the.spacet.me/</code>. As an API consumer, I would:</p><ol data-v-8c9498c0><li data-v-8c9498c0>Generate a request.</li><li data-v-8c9498c0>Cryptographically-sign the request into a JWT and construct an image URL.</li><li data-v-8c9498c0>Send the image URL to client (in a <code data-v-8c9498c0>&lt;meta property=&quot;og:image&quot;&gt;</code> tag).</li></ol><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-1.png" alt="Diagram for steps 1-3" data-v-8c9498c0></p><ol start="4" data-v-8c9498c0><li data-v-8c9498c0>The browser would then make a request to the service, which would, on request, take a screenshot</li><li data-v-8c9498c0>…and return the image back to the browser.</li></ol><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-2.png" alt="Diagram for steps 4-5" data-v-8c9498c0></p><p data-v-8c9498c0>The service maintains a list of tenants which are allowed to use the service. This allows the service to be reused in multiple projects without them having to share the same secret key.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-tenants.png" alt="A list of tenants" data-v-8c9498c0></p><h2 id="under-the-hood" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#under-the-hood" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Under the hood</h2><p data-v-8c9498c0>I was able to quickly build the first version of this service thanks to Vercel’s <a href="https://vercel.com/home" data-v-8c9498c0>Edge Network</a> and <a href="https://vercel.com/docs/serverless-functions/introduction" data-v-8c9498c0>Serverless Functions</a>.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-3.png" alt="Diagram for the components inside the service" data-v-8c9498c0></p><p data-v-8c9498c0>The first time a request is received:</p><ol data-v-8c9498c0><li data-v-8c9498c0>It would enter Vercel’s network.</li><li data-v-8c9498c0>Since this was the first time the request was processed, it would be a cache MISS.</li><li data-v-8c9498c0>Vercel would then call the underlying serverless function.</li><li data-v-8c9498c0>Which in turn validates the request and captures a screenshot of the webpage.</li></ol><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-4.png" alt="Diagram for cache miss scenario (1)" data-v-8c9498c0></p><ol start="5" data-v-8c9498c0><li data-v-8c9498c0>The image is returned from the serverless function with a very aggressive <a href="https://vercel.com/docs/serverless-functions/edge-caching#cache-control" data-v-8c9498c0>caching</a> header.</li><li data-v-8c9498c0>Vercel would return the response and put it into its cache.</li></ol><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-5.png" alt="Diagram for cache miss scenario (2)" data-v-8c9498c0></p><p data-v-8c9498c0>The next time the request is received, it would be served by <a href="https://vercel.com/docs/edge-network/caching" data-v-8c9498c0>Vercel’s cache</a>.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-6.png" alt="Diagram for cache miss scenario (3)" data-v-8c9498c0></p><h2 id="use-cases-unlocked" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#use-cases-unlocked" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Use cases unlocked</h2><h3 id="automatic-social-image-generation-for-all-my-web-projects" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#automatic-social-image-generation-for-all-my-web-projects" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Automatic social image generation for all my web projects</h3><p data-v-8c9498c0>If I create a web project or a blog post, but don’t want to spend the time crafting an <code data-v-8c9498c0>og:image</code> for each page, I can just use <code data-v-8c9498c0>personal-puppeteer</code> to generate a default <code data-v-8c9498c0>og:image</code> from the webpage’s screenshot.</p><p data-v-8c9498c0>Now when I share my article on Facebook, people would see the webpage’s screenshot.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/11/04/personal-puppeteer-cover.png" alt="A Facebook post where I posted an article. The preview image is the screenshot of the article’s contents." data-v-8c9498c0></p><p data-v-8c9498c0>Although it may not look as good as a handcrafted image, I think this is still way better than using a generic image or a profile picture as a default preview image.</p><p data-v-8c9498c0>So far, I am doing this for:</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href="https://dt.in.th/" data-v-8c9498c0>https://dt.in.th/</a> — My personal website</li><li data-v-8c9498c0><a href="https://notes.dt.in.th/" data-v-8c9498c0>https://notes.dt.in.th/</a> — This website where I publish notes</li><li data-v-8c9498c0><a href="https://capture.the.spacet.me/" data-v-8c9498c0>https://capture.the.spacet.me/</a> — <code data-v-8c9498c0>personal-puppeteer</code>’s landing page</li></ul><h3 id="sending-procedurally-generated-images-in-chat-rooms" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#sending-procedurally-generated-images-in-chat-rooms" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Sending procedurally generated images in chat rooms</h3><p data-v-8c9498c0>By using <code data-v-8c9498c0>data:</code> URLs, an HTML page can be embedded in the JWT. This can be useful when I want to create a chat bot that can generate infographics.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-discord.gif" alt="GIF demo" data-v-8c9498c0></p><h3 id="adding-web-page-screenshot-to-readmemd" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#adding-web-page-screenshot-to-readmemd" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Adding web page screenshot to <code data-v-8c9498c0>README.md</code></h3><p data-v-8c9498c0>The URL can be embedded into other websites to provide an auto-updating screenshot.</p><p data-v-8c9498c0><img src="https://static.dt.in.th/uploads/2020/10/15/pp-readme.png" alt="An image of the documentation website embedded in README" data-v-8c9498c0></p><h2 id="open-source" data-v-8c9498c0><a aria-hidden="true" tabindex="-1" href="#open-source" data-v-8c9498c0><span class="icon icon-link" data-v-8c9498c0></span></a>Open source</h2><p data-v-8c9498c0><a href="https://github.com/dtinth/personal-puppeteer" data-v-8c9498c0>This project is open source</a>, so you can run your own instance too!</p><!--]--></div>
        </div>
      </main>
      <footer>
        <div
          class="notes-layout-container mx-auto py-4 px-6 text-#8b8685 text-right text-sm"
          id="footerContents"
        >
          <notes-page-footer></notes-page-footer>
        </div>
      </footer>
    </div>
    <script>
window.precompiledNoteBehavior = function(require, exports, module, Vue) {"use strict";Object.defineProperty(exports, "__esModule", {value: true});const __sfc__ = {};
var _vue = require('vue');

const _withScopeId = n => (_vue.pushScopeId.call(void 0, "data-v-8c9498c0"),n=n(),_vue.popScopeId.call(void 0, ),n)
const _hoisted_1 = {
  class: "notes-callout",
  "data-type": "Caution"
}
const _hoisted_2 = { class: "notes-callout__label" }
const _hoisted_3 = /*#__PURE__*/ _withScopeId(() => /*#__PURE__*/_vue.createElementVNode.call(void 0, "p", null, [
  /*#__PURE__*/_vue.createTextVNode.call(void 0, "I no longer use this solution, and no longer maintain this project, as the solution to run Chrome in Vercel ("),
  /*#__PURE__*/_vue.createElementVNode.call(void 0, "a", { href: "https://www.npmjs.com/package/chrome-aws-lambda" }, "chrome-aws-lambda"),
  /*#__PURE__*/_vue.createTextVNode.call(void 0, ") hasn’t been updated in 3 years, causing websites to be rendered incorrectly. As of 2023, I run a private instance of "),
  /*#__PURE__*/_vue.createElementVNode.call(void 0, "a", { href: "https://github.com/dtinth/pptraas" }, "pptraas"),
  /*#__PURE__*/_vue.createTextVNode.call(void 0, " on Google Cloud Run and built a little gateway service on top of it. The source code for that part is not published, but basically, it invokes pptraas, saves the generated image in Linode Object Storage, and uses PostgreSQL to keep track of when the image was last generated. The list of allowed URLs and its corresponding configuration is stored in Google Sheets so it’s easy to manage.")
], -1 /* HOISTED */))
const _hoisted_4 = /*#__PURE__*/_vue.createStaticVNode.call(void 0, "<p data-v-8c9498c0>In the past 2 years I found myself having to install and configure <a href=\"https://github.com/puppeteer/puppeteer\" data-v-8c9498c0>Puppeteer</a> to capture webpage screenshots on so many occasions.</p><p data-v-8c9498c0>So I thought it would be great to have a generic API that captures webpage screenshots that I can reuse across multiple projects. The existence of serverless platforms like <a href=\"Vercel\" data-v-8c9498c0>Vercel</a> made it all the more easier to do this, even for personal projects.</p><h2 id=\"the-need-for-screenshotting-web-pages\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#the-need-for-screenshotting-web-pages\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>The need for screenshotting web pages</h2><p data-v-8c9498c0>I regularly find need to programmatically take screenshots of web pages.</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href=\"https://github.com/dtinth/timelapse\" data-v-8c9498c0>To capture a timelapse of my personal projects</a></li><li data-v-8c9498c0><a href=\"https://github.com/dtinth/html5-animation-video-renderer\" data-v-8c9498c0>To render web-based animations into a video file</a></li><li data-v-8c9498c0><a href=\"https://github.com/dtinth/applitools-hackathon#canvas-chart-test\" data-v-8c9498c0>To perform visual regression testing</a></li><li data-v-8c9498c0><a href=\"https://github.com/reactbkk/3.0.0-posters-nametags/blob/master/src/take-screenshot.js\" data-v-8c9498c0>To procedurally generate image assets in batch</a></li></ul><p data-v-8c9498c0>In each of these use cases I installed <a href=\"https://github.com/puppeteer/puppeteer\" data-v-8c9498c0>Puppeteer</a> and wrote similar code: Go to the web page, take a screenshot, output the image. But Puppeteer is quite a heavy dependency, weighting over 100 MB in <code data-v-8c9498c0>node_modules</code>.</p><p data-v-8c9498c0>In cases where the code is used in dynamic sites, I would had to set up <a href=\"https://rominirani.com/using-puppeteer-in-google-cloud-functions-809a14856e14\" data-v-8c9498c0>a Google Cloud function</a> or <a href=\"https://github.com/alixaxel/chrome-aws-lambda\" data-v-8c9498c0>an AWS Lambda function</a> for that use cases.</p><p data-v-8c9498c0>Wouldn’t it be great if, instead of setting up Puppeteer every time, there is an API that I can immediately use? Well, there is a <a href=\"https://phantomjscloud.com/\" data-v-8c9498c0>plenty</a> <a href=\"https://www.browserless.io/\" data-v-8c9498c0>of</a> <a href=\"https://puppet-master.sh/\" data-v-8c9498c0><del data-v-8c9498c0>existing</del></a> <a href=\"https://urlbox.io/\" data-v-8c9498c0>offerings</a>, but most of them are paid and <a href=\"https://github.com/GoogleChromeLabs/pptraas.com/issues/48\" data-v-8c9498c0>the free ones went down</a>. Even some of the paid ones went down (the links that are struck out are now dead).</p><p data-v-8c9498c0>Since I wanted to re-use it across multiple projects, spanning multiple years to come, I want some degree of control. The service should:</p><ul data-v-8c9498c0><li data-v-8c9498c0><strong data-v-8c9498c0>Run on my own domain name.</strong> I don&#39;t want to have to go through all my projects and migrate to a new service, just because the old service is sunsetted.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Be affordable or free.</strong> It’s for personal use and is non-commercial. I don’t want to spend too much money on it.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Personal yet multi-tenant.</strong> I may use it on a project that is shared with others. In a rare case that I need to revoke an access to one project, it should not disrupt other projects. Therefore, it should support multiple keys.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Secure.</strong> Others should not be able to use the service to screenshot arbitrary web pages without my permission.</li><li data-v-8c9498c0><strong data-v-8c9498c0>Single-shot API.</strong> Service consumers should be able to construct the image URL without having to make any extra API requests.</li></ul><h2 id=\"introducing-personal-puppeteer\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#introducing-personal-puppeteer\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Introducing personal-puppeteer</h2><p data-v-8c9498c0>So this is what I created. Here’s how it works:</p><p data-v-8c9498c0>First, let’s say I want to generate a <strong data-v-8c9498c0>social card image</strong> for the URL at <code data-v-8c9498c0>https://capture.the.spacet.me/</code>. As an API consumer, I would:</p><ol data-v-8c9498c0><li data-v-8c9498c0>Generate a request.</li><li data-v-8c9498c0>Cryptographically-sign the request into a JWT and construct an image URL.</li><li data-v-8c9498c0>Send the image URL to client (in a <code data-v-8c9498c0>&lt;meta property=&quot;og:image&quot;&gt;</code> tag).</li></ol><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-1.png\" alt=\"Diagram for steps 1-3\" data-v-8c9498c0></p><ol start=\"4\" data-v-8c9498c0><li data-v-8c9498c0>The browser would then make a request to the service, which would, on request, take a screenshot</li><li data-v-8c9498c0>…and return the image back to the browser.</li></ol><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-2.png\" alt=\"Diagram for steps 4-5\" data-v-8c9498c0></p><p data-v-8c9498c0>The service maintains a list of tenants which are allowed to use the service. This allows the service to be reused in multiple projects without them having to share the same secret key.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-tenants.png\" alt=\"A list of tenants\" data-v-8c9498c0></p><h2 id=\"under-the-hood\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#under-the-hood\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Under the hood</h2><p data-v-8c9498c0>I was able to quickly build the first version of this service thanks to Vercel’s <a href=\"https://vercel.com/home\" data-v-8c9498c0>Edge Network</a> and <a href=\"https://vercel.com/docs/serverless-functions/introduction\" data-v-8c9498c0>Serverless Functions</a>.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-3.png\" alt=\"Diagram for the components inside the service\" data-v-8c9498c0></p><p data-v-8c9498c0>The first time a request is received:</p><ol data-v-8c9498c0><li data-v-8c9498c0>It would enter Vercel’s network.</li><li data-v-8c9498c0>Since this was the first time the request was processed, it would be a cache MISS.</li><li data-v-8c9498c0>Vercel would then call the underlying serverless function.</li><li data-v-8c9498c0>Which in turn validates the request and captures a screenshot of the webpage.</li></ol><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-4.png\" alt=\"Diagram for cache miss scenario (1)\" data-v-8c9498c0></p><ol start=\"5\" data-v-8c9498c0><li data-v-8c9498c0>The image is returned from the serverless function with a very aggressive <a href=\"https://vercel.com/docs/serverless-functions/edge-caching#cache-control\" data-v-8c9498c0>caching</a> header.</li><li data-v-8c9498c0>Vercel would return the response and put it into its cache.</li></ol><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-5.png\" alt=\"Diagram for cache miss scenario (2)\" data-v-8c9498c0></p><p data-v-8c9498c0>The next time the request is received, it would be served by <a href=\"https://vercel.com/docs/edge-network/caching\" data-v-8c9498c0>Vercel’s cache</a>.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-6.png\" alt=\"Diagram for cache miss scenario (3)\" data-v-8c9498c0></p><h2 id=\"use-cases-unlocked\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#use-cases-unlocked\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Use cases unlocked</h2><h3 id=\"automatic-social-image-generation-for-all-my-web-projects\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#automatic-social-image-generation-for-all-my-web-projects\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Automatic social image generation for all my web projects</h3><p data-v-8c9498c0>If I create a web project or a blog post, but don’t want to spend the time crafting an <code data-v-8c9498c0>og:image</code> for each page, I can just use <code data-v-8c9498c0>personal-puppeteer</code> to generate a default <code data-v-8c9498c0>og:image</code> from the webpage’s screenshot.</p><p data-v-8c9498c0>Now when I share my article on Facebook, people would see the webpage’s screenshot.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/11/04/personal-puppeteer-cover.png\" alt=\"A Facebook post where I posted an article. The preview image is the screenshot of the article’s contents.\" data-v-8c9498c0></p><p data-v-8c9498c0>Although it may not look as good as a handcrafted image, I think this is still way better than using a generic image or a profile picture as a default preview image.</p><p data-v-8c9498c0>So far, I am doing this for:</p><ul data-v-8c9498c0><li data-v-8c9498c0><a href=\"https://dt.in.th/\" data-v-8c9498c0>https://dt.in.th/</a> — My personal website</li><li data-v-8c9498c0><a href=\"https://notes.dt.in.th/\" data-v-8c9498c0>https://notes.dt.in.th/</a> — This website where I publish notes</li><li data-v-8c9498c0><a href=\"https://capture.the.spacet.me/\" data-v-8c9498c0>https://capture.the.spacet.me/</a> — <code data-v-8c9498c0>personal-puppeteer</code>’s landing page</li></ul><h3 id=\"sending-procedurally-generated-images-in-chat-rooms\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#sending-procedurally-generated-images-in-chat-rooms\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Sending procedurally generated images in chat rooms</h3><p data-v-8c9498c0>By using <code data-v-8c9498c0>data:</code> URLs, an HTML page can be embedded in the JWT. This can be useful when I want to create a chat bot that can generate infographics.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-discord.gif\" alt=\"GIF demo\" data-v-8c9498c0></p><h3 id=\"adding-web-page-screenshot-to-readmemd\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#adding-web-page-screenshot-to-readmemd\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Adding web page screenshot to <code data-v-8c9498c0>README.md</code></h3><p data-v-8c9498c0>The URL can be embedded into other websites to provide an auto-updating screenshot.</p><p data-v-8c9498c0><img src=\"https://static.dt.in.th/uploads/2020/10/15/pp-readme.png\" alt=\"An image of the documentation website embedded in README\" data-v-8c9498c0></p><h2 id=\"open-source\" data-v-8c9498c0><a aria-hidden=\"true\" tabindex=\"-1\" href=\"#open-source\" data-v-8c9498c0><span class=\"icon icon-link\" data-v-8c9498c0></span></a>Open source</h2><p data-v-8c9498c0><a href=\"https://github.com/dtinth/personal-puppeteer\" data-v-8c9498c0>This project is open source</a>, so you can run your own instance too!</p>", 45)
function render(_ctx, _cache) {
  const _component_notes_callout_icon = _vue.resolveComponent.call(void 0, "notes-callout-icon")

  return (_vue.openBlock.call(void 0, ), _vue.createElementBlock.call(void 0, _vue.Fragment, null, [
    _vue.createElementVNode.call(void 0, "div", _hoisted_1, [
      _vue.createElementVNode.call(void 0, "p", _hoisted_2, [
        _vue.createVNode.call(void 0, _component_notes_callout_icon, { type: "Caution" }),
        _vue.createTextVNode.call(void 0, "Outdated")
      ]),
      _hoisted_3
    ]),
    _hoisted_4
  ], 64 /* STABLE_FRAGMENT */))
}
__sfc__.render = render
__sfc__.__scopeId = "data-v-8c9498c0"
__sfc__.__file = "Note.vue"
exports. default = __sfc__};
window.precompiledFrontMatter = {"title":"Building a personal but multi-tenant web page screenshotting service with Puppeteer and Vercel","project":"personal-puppeteer","public":true,"twitter":"https://twitter.com/dtinth/status/1323687070519324673","devto":"https://dev.to/dtinth/building-a-personal-but-multi-tenant-web-page-screenshotting-service-with-puppeteer-and-vercel-15b","facebook_copy":"ช่วงหลังๆ ที่ผมโพสต์บทความขึ้นเว็บ notes.dt.in.th แล้วเอามาแชร์บน Facebook จะเห็นว่า Preview image เป็น Screenshot ของหน้าบทความเลย\n\nถึงแม้การใช้รูป Screenshot มันอาจจะดูไม่สวยเท่าทำรูปให้แต่ละบทความเอง …แต่วิธีนี้ก็ช่วยประหยัดเวลาได้เยอะมาก (เพราะไม่ต้องทำอะไรเลย) …และมองว่าการใช้ท่านี้ มันก็ยังดีกว่าการเอาหน้าตัวเองหรือโลโก้เว็บมาทำเป็น Preview image (เพราะถ้าทำแบบนั้น รูปมันจะไม่สื่อถึงเนื้อหาข้างในเลย)\n\nเบื้องหลังคือ ผมสร้าง API ที่รับ URL มา… จากนั้น API ตัวนี้จะใช้ Puppeteer เพื่อไป Screenshot หน้าเว็บ แล้วส่งรูปกลับมาให้ Browser\n\nระบบเป็น stateless ทั้งหมด โดยวิธีการใช้งานคือเอา parameter ต่างๆ (URL, ความกว้าง, ความสูง) มาสร้างเป็น JWT แล้วก็เอามาประกอบเป็น URL ที่สามารถนำไปใส่ใน \u003cmeta property=\"og:image\"> ได้เลย… วิธีนี้ทำให้ API ตัวนี้สามารถเอาไปรียูสกับหลายๆ โปรเจคได้อย่างปลอดภัย\n\nเนื่องจากเป็นการ generate screenshot แบบ on-the-fly… request แรกจึงอาจจะช้าหน่อย แต่ request หลังๆ ก็จะเร็วขึ้น เพราะ cache ไว้บน CDN แล้ว\n\nDeploy ขึ้น Vercel สะดวกมากๆ เพราะมี serverless function + CDN ให้ใช้ฟรีๆ สำหรับโปรเจคส่วนตัว… รายละเอียดเพิ่มเติมอ่านได้ในบทความนี้ครับ โค้ดทั้งหมด open source เอาไปรันของตัวเองได้ด้วย\n","facebook":"https://www.facebook.com/dtinth/posts/10215688956691121","aliases":["20201014T185440Z9352"]};
</script>
  </body>
</html>
